
<!DOCTYPE html>
<!--[if IEMobile 7 ]><html class="no-js iem7"><![endif]-->
<!--[if lt IE 9]><html class="no-js lte-ie8"><![endif]-->
<!--[if (gt IE 8)|(gt IEMobile 7)|!(IEMobile)|!(IE)]><!--><html class="no-js" lang="en"><!--<![endif]-->
<head>
  <meta charset="utf-8">
  <title>Dependency Injection for Objective-C - Sean Dougherty</title>
  <meta name="author" content="Sean Dougherty">

  
  <meta name="description" content="Despite what some people think, TDD is alive and well. Fast running tests are awesome and breaking dependencies is the key to fast, isolated unit &hellip;">
  

  <!-- http://t.co/dKP3o1e -->
  <meta name="HandheldFriendly" content="True">
  <meta name="MobileOptimized" content="320">
  <meta name="viewport" content="width=device-width, initial-scale=1">

  
  <link rel="canonical" href="http://steam.github.io/blog/2014/05/28/dependency-injection-for-objective-c">
  <link href="/favicon.png" rel="icon">
  <link href="/stylesheets/screen.css" media="screen, projection" rel="stylesheet" type="text/css">
  <link href="/atom.xml" rel="alternate" title="Sean Dougherty" type="application/atom+xml">
  <script src="/javascripts/modernizr-2.0.js"></script>
  <script src="//ajax.googleapis.com/ajax/libs/jquery/1.9.1/jquery.min.js"></script>
  <script>!window.jQuery && document.write(unescape('%3Cscript src="./javascripts/libs/jquery.min.js"%3E%3C/script%3E'))</script>
  <script src="/javascripts/octopress.js" type="text/javascript"></script>
  <!--Fonts from Google"s Web font directory at http://google.com/webfonts -->
<link href='http://fonts.googleapis.com/css?family=Noto+Serif:400,700' rel='stylesheet' type='text/css'>
<link href='http://fonts.googleapis.com/css?family=Open+Sans:400,700' rel='stylesheet' type='text/css'>

  
  <script type="text/javascript">
    var _gaq = _gaq || [];
    _gaq.push(['_setAccount', 'UA-40996992-1']);
    _gaq.push(['_trackPageview']);

    (function() {
      var ga = document.createElement('script'); ga.type = 'text/javascript'; ga.async = true;
      ga.src = ('https:' == document.location.protocol ? 'https://ssl' : 'http://www') + '.google-analytics.com/ga.js';
      var s = document.getElementsByTagName('script')[0]; s.parentNode.insertBefore(ga, s);
    })();
  </script>


</head>

<body   >
  <header role="banner"><hgroup>
  <h1><a href="/">Sean Dougherty</a></h1>
  
    <h2>Some thoughts about mobile software development (mostly).</h2>
  
</hgroup>

</header>
  <nav role="navigation"><ul class="subscription" data-subscription="rss">
  
  
</ul>

<ul class="main-navigation">
  <li><a href="/blog">Blog</a></li>
  <li><a href="/blog/archives">Archives</a></li>
</ul>

</nav>
  <div id="main">
    <div id="content">
      <div>
<article class="hentry" role="article">
  
  <header>
    
      <h1 class="entry-title">Dependency Injection for Objective-C</h1>
    
    
      <p class="meta">
        








  


<time datetime="2014-05-28T23:01:00-06:00" pubdate data-updated="true">May 28<span>th</span>, 2014</time>
        
      </p>
    
  </header>


<div class="entry-content"><p>Despite what some <a href="http://david.heinemeierhansson.com/2014/tdd-is-dead-long-live-testing.html">people</a> think, TDD is alive and well. Fast running tests are awesome and breaking dependencies is the key to fast, isolated unit tests. Reliable tests give us the confidence to aggressively clean our code and add new features.</p>

<p>In iOS and OS X it is common to use singleton or singleton style service objects for app wide functionality. Apple provides several of these singleton service objects that are used in most applications. <code>[NSUserDefaults standardUserDefaults];</code> and <code>[NSNotificationCenter defaultCenter];</code> for example.</p>

<p>Both <code>NSUserDefaults</code> and <code>NSNotificationCenter</code> are notoriously painful to isolate in unit tests. <code>NSUserDefaults</code> is challenging because it writes to disk and has the potential of poluting the real running application after the test suite has run and we are back to using the app in the simulator. <code>NSNotificationCenter</code> introduces the possibility of test pollution due to it&rsquo;s global nature. Wouldn&rsquo;t it be nice if we had a system to seemlessly inject fake versions of these in our tests?</p>

<p>We do.</p>

<p>At <a href="http://www.gospotcheck.com">GoSpotCheck</a> we have a mechanism for injecting all of Apple&rsquo;s as well as all of our own singleton style dependencies. When running in the simulator or on a device the real service objects are injected. When the test target is running fake service objects are injected.</p>

<p>The rest of this post will detail out our approach to dependency injection. To keep things easy to understand the example is intentionally simplistic. The sample project <a href="https://github.com/steam/injections">Injections</a> is not organized like our production application and the test suite is XCTest in order to reduce the amount of setup needed to try it out. We use <a href="https://github.com/pivotal/cedar">Cedar</a> and <a href="https://github.com/specta/expecta">Expecta</a> at GoSpotCheck.</p>

<p>The example below shows how to dependency inject a fake <code>AFNetworkReachabilityManager</code> from <a href="https://twitter.com/mattt">Mattt Thompson&rsquo;s</a> fantastic <a href="https://github.com/AFNetworking/AFNetworking">AFNetworking</a> library. AFNetworking is a great network request library for iOS and OS X.</p>

<p><code>AFNetworkReachabilityManager</code> provides hooks for checking on, and being notified of a device&rsquo;s internet connectivity. To unit test online/offline conditional behavior in an app we need to be able control (or fake) the <code>AFNetworkReachabilityManager's</code> reported connection status. This example may seem like a lot of code is required to fake the connection status. That using a mocking framework like <a href="http://ocmock.org/">OCMock</a> might be simpler. It would be. For one off stubbing and mocking OCMock is great. However, in a large production application fakes are usually a better choice in my opinion. Application state is more straightforward with a system of injected fakes than one off mocking, especially for system wide service objects. These techniques are especially useful when unit testing true service objects that make network requests and return deserialized model objects.</p>

<p>Injections is a simple application that displays the device&rsquo;s connection status when launched. Follow the setup below to see it in action.</p>

<p><img src="/images/injections.jpg"></p>

<h2>Setup</h2>

<figure class='code'><div class="highlight"><table><tr><td class="gutter"><pre class="line-numbers"><span class='line-number'>1</span>
</pre></td><td class='code'><pre><code class=''><span class='line'>$ git clone git@github.com:steam/injections.git
</span></code></pre></td></tr></table></div></figure>


<p></p>

<p>We&rsquo;ll be looking at a handful of classes and categories.</p>

<p><code>Environment</code> is the class that initializes all the services. In a real application you&rsquo;d see properties for a <code>NSNotificationCenter</code>, <code>NSUserDefaults</code> and all other singleton style service objects here. These will be referenced by the <code>UIViewController+Injections</code> category and made available to all <code>UIViewControllers</code> that want access.</p>

<figure class='code'><figcaption><span>Environment.h</span></figcaption><div class="highlight"><table><tr><td class="gutter"><pre class="line-numbers"><span class='line-number'>1</span>
<span class='line-number'>2</span>
<span class='line-number'>3</span>
<span class='line-number'>4</span>
<span class='line-number'>5</span>
<span class='line-number'>6</span>
<span class='line-number'>7</span>
<span class='line-number'>8</span>
<span class='line-number'>9</span>
<span class='line-number'>10</span>
<span class='line-number'>11</span>
<span class='line-number'>12</span>
</pre></td><td class='code'><pre><code class='objective-c'><span class='line'><span class="cp">#import &lt;Foundation/Foundation.h&gt;</span>
</span><span class='line'>
</span><span class='line'><span class="k">@class</span> <span class="nc">AFNetworkReachabilityManager</span>;
</span><span class='line'>
</span><span class='line'><span class="k">@interface</span> <span class="nc">Environment</span> : <span class="nc">NSObject</span>
</span><span class='line'>
</span><span class='line'><span class="k">@property</span> <span class="p">(</span><span class="n">strong</span><span class="p">,</span> <span class="n">nonatomic</span><span class="p">,</span> <span class="n">readonly</span><span class="p">)</span> <span class="n">AFNetworkReachabilityManager</span> <span class="o">*</span><span class="n">reachabilityManager</span><span class="p">;</span>
</span><span class='line'>
</span><span class='line'><span class="k">+</span> <span class="p">(</span><span class="n">Environment</span> <span class="o">*</span><span class="p">)</span><span class="nf">singleton</span><span class="p">;</span>
</span><span class='line'><span class="k">-</span> <span class="p">(</span><span class="kt">BOOL</span><span class="p">)</span><span class="nf">isTestEnvironment</span><span class="p">;</span>
</span><span class='line'>
</span><span class='line'><span class="k">@end</span>
</span></code></pre></td></tr></table></div></figure>


<p>The key part to take note of is <code>-initializeServices</code>. We call <code>[self isTestEnvironment]</code> to determine if we are in the test environment. If <code>- (BOOL)isTestEnvironment</code> returns true then we initialize fake services, otherwise we initialize the real <code>reachabilityManager</code>.</p>

<figure class='code'><figcaption><span>Environment.m</span></figcaption><div class="highlight"><table><tr><td class="gutter"><pre class="line-numbers"><span class='line-number'>1</span>
<span class='line-number'>2</span>
<span class='line-number'>3</span>
<span class='line-number'>4</span>
<span class='line-number'>5</span>
<span class='line-number'>6</span>
<span class='line-number'>7</span>
<span class='line-number'>8</span>
<span class='line-number'>9</span>
<span class='line-number'>10</span>
<span class='line-number'>11</span>
<span class='line-number'>12</span>
<span class='line-number'>13</span>
<span class='line-number'>14</span>
<span class='line-number'>15</span>
<span class='line-number'>16</span>
</pre></td><td class='code'><pre><code class='objective-c'><span class='line'><span class="p">...</span>
</span><span class='line'><span class="o">-</span> <span class="p">(</span><span class="kt">void</span><span class="p">)</span><span class="n">initializeServices</span>
</span><span class='line'><span class="p">{</span>
</span><span class='line'>    <span class="k">if</span> <span class="p">([</span><span class="n">self</span> <span class="n">isTestEnvironment</span><span class="p">])</span>
</span><span class='line'>    <span class="p">{</span>
</span><span class='line'>        <span class="p">[</span><span class="n">self</span> <span class="nl">performSelector:</span><span class="k">@selector</span><span class="p">(</span><span class="n">initializeFakeServices</span><span class="p">)];</span>
</span><span class='line'>        <span class="k">return</span><span class="p">;</span>
</span><span class='line'>    <span class="p">}</span>
</span><span class='line'>
</span><span class='line'>    <span class="n">self</span><span class="p">.</span><span class="n">reachabilityManager</span> <span class="o">=</span> <span class="p">[</span><span class="n">AFNetworkReachabilityManager</span> <span class="n">sharedManager</span><span class="p">];</span>
</span><span class='line'><span class="p">}</span>
</span><span class='line'>
</span><span class='line'><span class="o">-</span> <span class="p">(</span><span class="kt">BOOL</span><span class="p">)</span><span class="n">isTestEnvironment</span> <span class="p">{</span>
</span><span class='line'>    <span class="k">return</span> <span class="p">[</span><span class="n">self</span> <span class="nl">respondsToSelector:</span><span class="k">@selector</span><span class="p">(</span><span class="n">initializeFakeServices</span><span class="p">)];</span>
</span><span class='line'><span class="p">}</span>
</span><span class='line'><span class="p">...</span>
</span></code></pre></td></tr></table></div></figure>


<p>The magic happens with <code>[self respondsToSelector:@selector(initializeFakeServices)]</code>. In the non-test target this will return false. In the test target it will return true because of the <code>Environment+Fake</code> category imported in <code>ViewControllerTests.m</code>.</p>

<figure class='code'><figcaption><span>Environment+Fake.m</span></figcaption><div class="highlight"><table><tr><td class="gutter"><pre class="line-numbers"><span class='line-number'>1</span>
<span class='line-number'>2</span>
<span class='line-number'>3</span>
<span class='line-number'>4</span>
<span class='line-number'>5</span>
<span class='line-number'>6</span>
<span class='line-number'>7</span>
<span class='line-number'>8</span>
<span class='line-number'>9</span>
<span class='line-number'>10</span>
<span class='line-number'>11</span>
</pre></td><td class='code'><pre><code class='objective-c'><span class='line'><span class="cp">#import &quot;Environment+Fake.h&quot;</span>
</span><span class='line'><span class="cp">#import &quot;FakeReachabilityManager.h&quot;</span>
</span><span class='line'>
</span><span class='line'><span class="k">@implementation</span> <span class="nc">Environment</span> <span class="nl">(Fake)</span>
</span><span class='line'>
</span><span class='line'><span class="k">-</span> <span class="p">(</span><span class="kt">void</span><span class="p">)</span><span class="nf">initializeFakeServices</span>
</span><span class='line'><span class="p">{</span>
</span><span class='line'>    <span class="p">[</span><span class="n">self</span> <span class="nl">setValue:</span><span class="p">[</span><span class="n">FakeReachabilityManager</span> <span class="n">sharedManager</span><span class="p">]</span> <span class="nl">forKey:</span><span class="s">@&quot;reachabilityManager&quot;</span><span class="p">];</span>
</span><span class='line'><span class="p">}</span>
</span><span class='line'>
</span><span class='line'><span class="k">@end</span>
</span></code></pre></td></tr></table></div></figure>


<p><code>Environment+Fake</code> sets <code>[FakeReachabilityManager sharedManager]</code> as the value for <code>self.reachabilityManager</code>. We&rsquo;ll see below that <code>ViewController</code> will use the fake version of <code>self.reachabilityManager</code> in the test target while using the real <code>reachabilityManager</code> in the non-test target.</p>

<p>The <code>UIViewController+Injections</code> category is in charge of defining methods that returns each of the services we want to expose to our view controllers. In this case <code>reachabilityManager</code> is returned from the <code>Environment</code> singleton object. This method will return either the real or fake version of the <code>reachabilityManager</code> depending on the target.</p>

<figure class='code'><figcaption><span>UIViewController+Injections.m</span></figcaption><div class="highlight"><table><tr><td class="gutter"><pre class="line-numbers"><span class='line-number'>1</span>
<span class='line-number'>2</span>
<span class='line-number'>3</span>
<span class='line-number'>4</span>
<span class='line-number'>5</span>
<span class='line-number'>6</span>
<span class='line-number'>7</span>
<span class='line-number'>8</span>
</pre></td><td class='code'><pre><code class='objective-c'><span class='line'><span class="k">@implementation</span> <span class="nc">UIViewController</span> <span class="nl">(Injections)</span>
</span><span class='line'>
</span><span class='line'><span class="k">-</span> <span class="p">(</span><span class="n">AFNetworkReachabilityManager</span> <span class="o">*</span><span class="p">)</span><span class="nf">reachabilityManager</span>
</span><span class='line'><span class="p">{</span>
</span><span class='line'>    <span class="k">return</span> <span class="p">[</span><span class="n">Environment</span> <span class="n">singleton</span><span class="p">].</span><span class="n">reachabilityManager</span><span class="p">;</span>
</span><span class='line'><span class="p">}</span>
</span><span class='line'>
</span><span class='line'><span class="k">@end</span>
</span></code></pre></td></tr></table></div></figure>


<p><code>ViewController</code> uses the <code>reachabilityManager</code> to determine what text to display to the user. If <code>self.reachabilityManger.networkReachabilityStatus</code> is reachable the label&rsquo;s text is set to &ldquo;online&rdquo;, if not then it is set to &ldquo;offline&rdquo;. Take note of the <code>@property (strong, nonatomic) AFNetworkReachabilityManager *reachabilityManager;</code> declaration in the header as well as it&rsquo;s corresponding <code>@dynamic reachabilityManager;</code> in the implementation file. All <code>UIViewController</code> subclasses have access to the <code>UIViewController+Injections</code> category methods which allows them to be set as properties on each <code>ViewController</code> subclass and dynamically evaluated at runtime.</p>

<figure class='code'><figcaption><span>ViewController.h</span></figcaption><div class="highlight"><table><tr><td class="gutter"><pre class="line-numbers"><span class='line-number'>1</span>
<span class='line-number'>2</span>
<span class='line-number'>3</span>
<span class='line-number'>4</span>
<span class='line-number'>5</span>
<span class='line-number'>6</span>
<span class='line-number'>7</span>
<span class='line-number'>8</span>
<span class='line-number'>9</span>
<span class='line-number'>10</span>
<span class='line-number'>11</span>
<span class='line-number'>12</span>
</pre></td><td class='code'><pre><code class='objective-c'><span class='line'><span class="cp">#import &lt;UIKit/UIKit.h&gt;</span>
</span><span class='line'>
</span><span class='line'><span class="k">@class</span> <span class="nc">AFNetworkReachabilityManager</span>;
</span><span class='line'>
</span><span class='line'><span class="k">@interface</span> <span class="nc">ViewController</span> : <span class="nc">UIViewController</span>
</span><span class='line'>
</span><span class='line'><span class="k">@property</span> <span class="p">(</span><span class="n">nonatomic</span><span class="p">,</span> <span class="n">weak</span><span class="p">)</span> <span class="kt">IBOutlet</span> <span class="n">UILabel</span> <span class="o">*</span><span class="n">internetStatusLabel</span><span class="p">;</span>
</span><span class='line'>
</span><span class='line'><span class="cm">/* &quot;Injected&quot; properties -- Each should have a corresponding @dynamic directive */</span>
</span><span class='line'><span class="k">@property</span> <span class="p">(</span><span class="n">strong</span><span class="p">,</span> <span class="n">nonatomic</span><span class="p">)</span> <span class="n">AFNetworkReachabilityManager</span> <span class="o">*</span><span class="n">reachabilityManager</span><span class="p">;</span>
</span><span class='line'>
</span><span class='line'><span class="k">@end</span>
</span></code></pre></td></tr></table></div></figure>




<figure class='code'><figcaption><span>ViewController.m</span></figcaption><div class="highlight"><table><tr><td class="gutter"><pre class="line-numbers"><span class='line-number'>1</span>
<span class='line-number'>2</span>
<span class='line-number'>3</span>
<span class='line-number'>4</span>
<span class='line-number'>5</span>
<span class='line-number'>6</span>
<span class='line-number'>7</span>
<span class='line-number'>8</span>
<span class='line-number'>9</span>
<span class='line-number'>10</span>
<span class='line-number'>11</span>
<span class='line-number'>12</span>
<span class='line-number'>13</span>
<span class='line-number'>14</span>
<span class='line-number'>15</span>
<span class='line-number'>16</span>
<span class='line-number'>17</span>
<span class='line-number'>18</span>
<span class='line-number'>19</span>
<span class='line-number'>20</span>
<span class='line-number'>21</span>
<span class='line-number'>22</span>
<span class='line-number'>23</span>
<span class='line-number'>24</span>
<span class='line-number'>25</span>
<span class='line-number'>26</span>
<span class='line-number'>27</span>
<span class='line-number'>28</span>
</pre></td><td class='code'><pre><code class='objective-c'><span class='line'><span class="cp">#import &quot;ViewController.h&quot;</span>
</span><span class='line'><span class="cp">#import &lt;AFNetworking/AFNetworkReachabilityManager.h&gt;</span>
</span><span class='line'>
</span><span class='line'><span class="k">@implementation</span> <span class="nc">ViewController</span>
</span><span class='line'>
</span><span class='line'><span class="k">@dynamic</span> <span class="n">reachabilityManager</span><span class="p">;</span>
</span><span class='line'>
</span><span class='line'><span class="k">-</span> <span class="p">(</span><span class="kt">void</span><span class="p">)</span><span class="nf">viewDidLoad</span>
</span><span class='line'><span class="p">{</span>
</span><span class='line'>    <span class="p">[</span><span class="n">super</span> <span class="n">viewDidLoad</span><span class="p">];</span>
</span><span class='line'>    <span class="p">[</span><span class="n">self</span> <span class="n">displayOnlineStatus</span><span class="p">];</span>
</span><span class='line'><span class="p">}</span>
</span><span class='line'>
</span><span class='line'><span class="k">-</span> <span class="p">(</span><span class="kt">void</span><span class="p">)</span><span class="nf">displayOnlineStatus</span>
</span><span class='line'><span class="p">{</span>
</span><span class='line'>    <span class="kt">BOOL</span> <span class="n">reachable</span> <span class="o">=</span> <span class="n">self</span><span class="p">.</span><span class="n">reachabilityManager</span><span class="p">.</span><span class="n">networkReachabilityStatus</span> <span class="o">!=</span> <span class="n">AFNetworkReachabilityStatusNotReachable</span><span class="p">;</span>
</span><span class='line'>
</span><span class='line'>    <span class="k">if</span> <span class="p">(</span><span class="n">reachable</span><span class="p">)</span>
</span><span class='line'>    <span class="p">{</span>
</span><span class='line'>        <span class="n">self</span><span class="p">.</span><span class="n">internetStatusLabel</span><span class="p">.</span><span class="n">text</span> <span class="o">=</span> <span class="n">NSLocalizedString</span><span class="p">(</span><span class="s">@&quot;online&quot;</span><span class="p">,</span> <span class="nb">nil</span><span class="p">);</span>
</span><span class='line'>    <span class="p">}</span>
</span><span class='line'>    <span class="k">else</span>
</span><span class='line'>    <span class="p">{</span>
</span><span class='line'>        <span class="n">self</span><span class="p">.</span><span class="n">internetStatusLabel</span><span class="p">.</span><span class="n">text</span> <span class="o">=</span> <span class="n">NSLocalizedString</span><span class="p">(</span><span class="s">@&quot;offline&quot;</span><span class="p">,</span> <span class="nb">nil</span><span class="p">);</span>
</span><span class='line'>    <span class="p">}</span>
</span><span class='line'><span class="p">}</span>
</span><span class='line'>
</span><span class='line'><span class="k">@end</span>
</span></code></pre></td></tr></table></div></figure>


<p>The final two pieces of the puzzle are in our test suite. <code>ViewControllerTests.m</code> and <code>FakeReachabilityManager</code> take care of the rest.</p>

<p>First, <code>FakeReachabilityManager</code> provides access to toggling the reported connection status as online or offline.</p>

<figure class='code'><figcaption><span>FakeReachabilityManager.h</span></figcaption><div class="highlight"><table><tr><td class="gutter"><pre class="line-numbers"><span class='line-number'>1</span>
<span class='line-number'>2</span>
<span class='line-number'>3</span>
<span class='line-number'>4</span>
<span class='line-number'>5</span>
<span class='line-number'>6</span>
<span class='line-number'>7</span>
<span class='line-number'>8</span>
</pre></td><td class='code'><pre><code class='objective-c'><span class='line'><span class="cp">#import &quot;AFNetworkReachabilityManager.h&quot;</span>
</span><span class='line'>
</span><span class='line'><span class="k">@interface</span> <span class="nc">FakeReachabilityManager</span> : <span class="nc">AFNetworkReachabilityManager</span>
</span><span class='line'>
</span><span class='line'><span class="k">-</span> <span class="p">(</span><span class="kt">void</span><span class="p">)</span><span class="nf">setOffline</span><span class="p">;</span>
</span><span class='line'><span class="k">-</span> <span class="p">(</span><span class="kt">void</span><span class="p">)</span><span class="nf">setOnline</span><span class="p">;</span>
</span><span class='line'>
</span><span class='line'><span class="k">@end</span>
</span></code></pre></td></tr></table></div></figure>


<p>By calling <code>-setOffline</code> or <code>-setOnline</code> we&rsquo;re able to override <code>- (AFNetworkReachabilityStatus)networkReachabilityStatus</code> having it return the value of <code>self.fakeStatus</code> set in the <code>-setOffline</code> or <code>-setOnline</code> calls.</p>

<figure class='code'><figcaption><span>FakeReachabilityManager.m</span></figcaption><div class="highlight"><table><tr><td class="gutter"><pre class="line-numbers"><span class='line-number'>1</span>
<span class='line-number'>2</span>
<span class='line-number'>3</span>
<span class='line-number'>4</span>
<span class='line-number'>5</span>
<span class='line-number'>6</span>
<span class='line-number'>7</span>
<span class='line-number'>8</span>
<span class='line-number'>9</span>
<span class='line-number'>10</span>
<span class='line-number'>11</span>
<span class='line-number'>12</span>
<span class='line-number'>13</span>
<span class='line-number'>14</span>
<span class='line-number'>15</span>
<span class='line-number'>16</span>
<span class='line-number'>17</span>
<span class='line-number'>18</span>
<span class='line-number'>19</span>
<span class='line-number'>20</span>
<span class='line-number'>21</span>
<span class='line-number'>22</span>
<span class='line-number'>23</span>
</pre></td><td class='code'><pre><code class='objective-c'><span class='line'><span class="k">@interface</span> <span class="nc">FakeReachabilityManager</span><span class="p">()</span>
</span><span class='line'><span class="k">@property</span> <span class="p">(</span><span class="n">nonatomic</span><span class="p">,</span> <span class="n">assign</span><span class="p">)</span> <span class="n">AFNetworkReachabilityStatus</span> <span class="n">fakeStatus</span><span class="p">;</span>
</span><span class='line'><span class="k">@end</span>
</span><span class='line'>
</span><span class='line'>
</span><span class='line'><span class="k">@implementation</span> <span class="nc">FakeReachabilityManager</span>
</span><span class='line'>
</span><span class='line'><span class="k">-</span> <span class="p">(</span><span class="kt">void</span><span class="p">)</span><span class="nf">setOffline</span>
</span><span class='line'><span class="p">{</span>
</span><span class='line'>    <span class="n">self</span><span class="p">.</span><span class="n">fakeStatus</span> <span class="o">=</span> <span class="n">AFNetworkReachabilityStatusNotReachable</span><span class="p">;</span>
</span><span class='line'><span class="p">}</span>
</span><span class='line'>
</span><span class='line'><span class="k">-</span> <span class="p">(</span><span class="kt">void</span><span class="p">)</span><span class="nf">setOnline</span>
</span><span class='line'><span class="p">{</span>
</span><span class='line'>    <span class="n">self</span><span class="p">.</span><span class="n">fakeStatus</span> <span class="o">=</span> <span class="n">AFNetworkReachabilityStatusReachableViaWWAN</span><span class="p">;</span>
</span><span class='line'><span class="p">}</span>
</span><span class='line'>
</span><span class='line'><span class="k">-</span> <span class="p">(</span><span class="n">AFNetworkReachabilityStatus</span><span class="p">)</span><span class="nf">networkReachabilityStatus</span>
</span><span class='line'><span class="p">{</span>
</span><span class='line'>    <span class="k">return</span> <span class="n">self</span><span class="p">.</span><span class="n">fakeStatus</span><span class="p">;</span>
</span><span class='line'><span class="p">}</span>
</span><span class='line'>
</span><span class='line'><span class="k">@end</span>
</span></code></pre></td></tr></table></div></figure>


<p>Finally, we make use of our <code>FakeReachabilityManager</code> in <code>ViewControllerTests.m</code>.</p>

<figure class='code'><figcaption><span>ViewControllerTests.m</span></figcaption><div class="highlight"><table><tr><td class="gutter"><pre class="line-numbers"><span class='line-number'>1</span>
<span class='line-number'>2</span>
<span class='line-number'>3</span>
<span class='line-number'>4</span>
<span class='line-number'>5</span>
<span class='line-number'>6</span>
<span class='line-number'>7</span>
<span class='line-number'>8</span>
<span class='line-number'>9</span>
<span class='line-number'>10</span>
<span class='line-number'>11</span>
<span class='line-number'>12</span>
<span class='line-number'>13</span>
<span class='line-number'>14</span>
<span class='line-number'>15</span>
<span class='line-number'>16</span>
<span class='line-number'>17</span>
<span class='line-number'>18</span>
<span class='line-number'>19</span>
<span class='line-number'>20</span>
<span class='line-number'>21</span>
<span class='line-number'>22</span>
<span class='line-number'>23</span>
<span class='line-number'>24</span>
<span class='line-number'>25</span>
<span class='line-number'>26</span>
<span class='line-number'>27</span>
<span class='line-number'>28</span>
<span class='line-number'>29</span>
<span class='line-number'>30</span>
<span class='line-number'>31</span>
<span class='line-number'>32</span>
<span class='line-number'>33</span>
<span class='line-number'>34</span>
<span class='line-number'>35</span>
<span class='line-number'>36</span>
<span class='line-number'>37</span>
<span class='line-number'>38</span>
<span class='line-number'>39</span>
<span class='line-number'>40</span>
<span class='line-number'>41</span>
<span class='line-number'>42</span>
<span class='line-number'>43</span>
<span class='line-number'>44</span>
<span class='line-number'>45</span>
<span class='line-number'>46</span>
<span class='line-number'>47</span>
<span class='line-number'>48</span>
<span class='line-number'>49</span>
<span class='line-number'>50</span>
<span class='line-number'>51</span>
<span class='line-number'>52</span>
<span class='line-number'>53</span>
<span class='line-number'>54</span>
<span class='line-number'>55</span>
<span class='line-number'>56</span>
</pre></td><td class='code'><pre><code class='objective-c'><span class='line'><span class="cp">#import &lt;XCTest/XCTest.h&gt;</span>
</span><span class='line'><span class="cp">#import &quot;Environment+Fake.h&quot;</span>
</span><span class='line'><span class="cp">#import &quot;ViewController.h&quot;</span>
</span><span class='line'><span class="cp">#import &quot;FakeReachabilityManager.h&quot;</span>
</span><span class='line'>
</span><span class='line'>
</span><span class='line'><span class="k">@interface</span> <span class="nc">ViewControllerTests</span> : <span class="nc">XCTestCase</span>
</span><span class='line'>
</span><span class='line'><span class="k">@property</span> <span class="p">(</span><span class="n">nonatomic</span><span class="p">,</span> <span class="n">strong</span><span class="p">)</span> <span class="n">ViewController</span> <span class="o">*</span><span class="n">controller</span><span class="p">;</span>
</span><span class='line'>
</span><span class='line'><span class="k">@end</span>
</span><span class='line'>
</span><span class='line'>
</span><span class='line'><span class="k">@implementation</span> <span class="nc">ViewControllerTests</span>
</span><span class='line'>
</span><span class='line'><span class="k">-</span> <span class="p">(</span><span class="kt">void</span><span class="p">)</span><span class="nf">setUp</span>
</span><span class='line'><span class="p">{</span>
</span><span class='line'>    <span class="p">[</span><span class="n">super</span> <span class="n">setUp</span><span class="p">];</span>
</span><span class='line'>    <span class="n">UIStoryboard</span> <span class="o">*</span><span class="n">storyboard</span> <span class="o">=</span> <span class="p">[</span><span class="n">UIStoryboard</span> <span class="nl">storyboardWithName:</span><span class="s">@&quot;Main&quot;</span> <span class="nl">bundle:</span><span class="nb">nil</span><span class="p">];</span>
</span><span class='line'>    <span class="n">self</span><span class="p">.</span><span class="n">controller</span> <span class="o">=</span> <span class="p">(</span><span class="n">ViewController</span> <span class="o">*</span><span class="p">)[</span><span class="n">storyboard</span> <span class="n">instantiateInitialViewController</span><span class="p">];</span>
</span><span class='line'>    <span class="p">[</span><span class="n">self</span><span class="p">.</span><span class="n">controller</span> <span class="n">loadView</span><span class="p">];</span>
</span><span class='line'><span class="p">}</span>
</span><span class='line'>
</span><span class='line'><span class="k">-</span> <span class="p">(</span><span class="kt">void</span><span class="p">)</span><span class="nf">tearDown</span>
</span><span class='line'><span class="p">{</span>
</span><span class='line'>    <span class="p">[</span><span class="n">super</span> <span class="n">tearDown</span><span class="p">];</span>
</span><span class='line'><span class="p">}</span>
</span><span class='line'>
</span><span class='line'><span class="k">-</span> <span class="p">(</span><span class="kt">void</span><span class="p">)</span><span class="nf">testOnlineLabelDisplaysOfflineWhenOffline</span>
</span><span class='line'><span class="p">{</span>
</span><span class='line'>    <span class="n">FakeReachabilityManager</span> <span class="o">*</span><span class="n">manager</span> <span class="o">=</span> <span class="p">(</span><span class="n">FakeReachabilityManager</span> <span class="o">*</span><span class="p">)</span><span class="n">self</span><span class="p">.</span><span class="n">controller</span><span class="p">.</span><span class="n">reachabilityManager</span><span class="p">;</span>
</span><span class='line'>    <span class="p">[</span><span class="n">manager</span> <span class="n">setOffline</span><span class="p">];</span>
</span><span class='line'>
</span><span class='line'>    <span class="p">[</span><span class="n">self</span><span class="p">.</span><span class="n">controller</span> <span class="n">viewDidLoad</span><span class="p">];</span>
</span><span class='line'>
</span><span class='line'>    <span class="n">NSString</span> <span class="o">*</span><span class="n">expectedResult</span> <span class="o">=</span> <span class="s">@&quot;offline&quot;</span><span class="p">;</span>
</span><span class='line'>    <span class="n">NSString</span> <span class="o">*</span><span class="n">text</span> <span class="o">=</span> <span class="n">self</span><span class="p">.</span><span class="n">controller</span><span class="p">.</span><span class="n">internetStatusLabel</span><span class="p">.</span><span class="n">text</span><span class="p">;</span>
</span><span class='line'>
</span><span class='line'>    <span class="n">XCTAssertTrue</span><span class="p">([</span><span class="n">text</span> <span class="nl">isEqualToString:</span><span class="n">expectedResult</span><span class="p">],</span> <span class="s">@&quot;Strings are not equal %@ %@&quot;</span><span class="p">,</span> <span class="n">text</span><span class="p">,</span> <span class="n">expectedResult</span><span class="p">);</span>
</span><span class='line'><span class="p">}</span>
</span><span class='line'>
</span><span class='line'><span class="k">-</span> <span class="p">(</span><span class="kt">void</span><span class="p">)</span><span class="nf">testOnlineLabelDisplaysOnlineWhenOnline</span>
</span><span class='line'><span class="p">{</span>
</span><span class='line'>    <span class="n">FakeReachabilityManager</span> <span class="o">*</span><span class="n">manager</span> <span class="o">=</span> <span class="p">(</span><span class="n">FakeReachabilityManager</span> <span class="o">*</span><span class="p">)</span><span class="n">self</span><span class="p">.</span><span class="n">controller</span><span class="p">.</span><span class="n">reachabilityManager</span><span class="p">;</span>
</span><span class='line'>    <span class="p">[</span><span class="n">manager</span> <span class="n">setOnline</span><span class="p">];</span>
</span><span class='line'>
</span><span class='line'>    <span class="p">[</span><span class="n">self</span><span class="p">.</span><span class="n">controller</span> <span class="n">viewDidLoad</span><span class="p">];</span>
</span><span class='line'>
</span><span class='line'>    <span class="n">NSString</span> <span class="o">*</span><span class="n">expectedResult</span> <span class="o">=</span> <span class="s">@&quot;online&quot;</span><span class="p">;</span>
</span><span class='line'>    <span class="n">NSString</span> <span class="o">*</span><span class="n">text</span> <span class="o">=</span> <span class="n">self</span><span class="p">.</span><span class="n">controller</span><span class="p">.</span><span class="n">internetStatusLabel</span><span class="p">.</span><span class="n">text</span><span class="p">;</span>
</span><span class='line'>
</span><span class='line'>    <span class="n">XCTAssertTrue</span><span class="p">([</span><span class="n">text</span> <span class="nl">isEqualToString:</span><span class="n">expectedResult</span><span class="p">],</span> <span class="s">@&quot;Strings are not equal %@ %@&quot;</span><span class="p">,</span> <span class="n">text</span><span class="p">,</span> <span class="n">expectedResult</span><span class="p">);</span>
</span><span class='line'><span class="p">}</span>
</span><span class='line'>
</span><span class='line'>
</span><span class='line'><span class="k">@end</span>
</span></code></pre></td></tr></table></div></figure>


<p>By toggling our <code>reachabilityManager's</code> online status through the fake we are able to write assertions about the label&rsquo;s text for both online and offline states.</p>

<h2>Summary</h2>

<ul>
<li><code>Environment</code> handles the setup of service objects.</li>
<li><code>Environment+Fake</code> sets fake services in the test target.</li>
<li><code>UIViewController+Injections</code> provides service access to <code>UIViewControllers</code>.</li>
<li><code>@dynamic</code> accessors makes this possible.</li>
<li><code>ViewControllerTests.m</code> is able to use the fake service object and control the external dependency.</li>
</ul>


<p>As I mentioned above, this example feels like overkill for this particular use case due to the simplicity of the app. In practice however this technique makes it possible to have fine grain control over a host of complicated services and objects. When your app has hundreds of classes and thousands of tests you&rsquo;ll see your hard work paid back many times over. The tests will run fast and predictably (our current test suite takes under 15 seconds to run ~1400 tests). TDD and near complete test coverage can only happen when you have confidence in the test suite and you can execute them fast enough to do it often. Breaking dependencies on asynchronous code and hard to control state is crucial.</p>

<p>Approach this in a different way? Completely disagree? Love the technique? Reach out and let me know on twitter <a href="https://twitter.com/sdougherty">@sdougherty</a>.</p>
</div>


  <footer>
    <p class="meta">
      
  

<span class="byline author vcard">Posted by <span class="fn">Sean Dougherty</span></span>

      








  


<time datetime="2014-05-28T23:01:00-06:00" pubdate data-updated="true">May 28<span>th</span>, 2014</time>
      

<span class="categories">
  
    <a class='category' href='/blog/categories/objective-c/'>Objective-C</a>, <a class='category' href='/blog/categories/ios/'>iOS,</a>
  
</span>


    </p>
    
      <div class="sharing">
  
  <a href="//twitter.com/share" class="twitter-share-button" data-url="http://steam.github.io/blog/2014/05/28/dependency-injection-for-objective-c/" data-via="sdougherty" data-counturl="http://steam.github.io/blog/2014/05/28/dependency-injection-for-objective-c/" >Tweet</a>
  
  
  
</div>

    
    <p class="meta">
      
        <a class="basic-alignment left" href="/blog/2014/05/17/android-vs-ios-from-an-ios-developers-perspective/" title="Previous Post: Android vs iOS from an iOS developer's perspective">&laquo; Android vs iOS from an iOS developer's perspective</a>
      
      
        <a class="basic-alignment right" href="/blog/2014/06/05/wwdc-2014/" title="Next Post: WWDC 2014">WWDC 2014 &raquo;</a>
      
    </p>
  </footer>
</article>

</div>

  <aside class="sidebar">
   
<form action="http://google.com/search" method="get">
  <fieldset role="search">
    <input type="hidden" name="q" value="site:steam.github.io" />
    <input class="search" type="text" name="q" results="0" placeholder="Search"/>
  </fieldset>
</form>
  
  
    <section>
  <h1>About Me</h1>
  <p>I am a mobile software engineer living in Denver Colorado. I spend my time writing code, mostly swift, hanging out with my 3 boys, injuring myself while running and playing drums.</p>
	<p>I am currently the Mobile Lead working with the awesome folks at <a href="http://ello.co">Ello</a>.</p>
</section>
<section>
  <div>
    <p><br /><a href="https://ello.co/sean">Come say hi at Ello</a></p>
  </div>
</section>

<section>
  <div>
    <p><br /><a href="http://twitter.com/sdougherty">My Tweets, on Twitter.</a></p>
    <a href="http://twitter.com/sdougherty" class="twitter-follow-button" data-show-count="">Follow @sdougherty</a>
  </div>
</section>
<section>
  <h1>Recent Posts</h1>
  <ul id="recent_posts">
    
      <li class="post">
        <a href="/blog/2014/12/31/more-functional-please/">More Functional Please</a>
      </li>
    
      <li class="post">
        <a href="/blog/2014/12/30/space-exploration/">Space Exploration</a>
      </li>
    
      <li class="post">
        <a href="/blog/2014/06/17/swift/">Swift</a>
      </li>
    
      <li class="post">
        <a href="/blog/2014/06/05/wwdc-2014/">WWDC 2014</a>
      </li>
    
      <li class="post">
        <a href="/blog/2014/05/28/dependency-injection-for-objective-c/">Dependency Injection for Objective-C</a>
      </li>
    
  </ul>
</section>





  
</aside>



    </div>
  </div>
  <footer role="contentinfo"><p>
  Copyright &copy; 2016 - Sean Dougherty -
  <span class="credit">Powered by <a href="http://octopress.org">Octopress</a></span>
</p>

</footer>
  







  <script type="text/javascript">
    (function(){
      var twitterWidgets = document.createElement('script');
      twitterWidgets.type = 'text/javascript';
      twitterWidgets.async = true;
      twitterWidgets.src = '//platform.twitter.com/widgets.js';
      document.getElementsByTagName('head')[0].appendChild(twitterWidgets);
    })();
  </script>



<script>
  $(document).ready(function() {  
  var stickyNavTop = $('nav').offset().top;  
    
  var stickyNav = function(){  
  var scrollTop = $(window).scrollTop();  
         
  if (scrollTop > stickyNavTop) {   
      $('nav').addClass('sticky');  
  } else {  
      $('nav').removeClass('sticky');   
  }  
  };  
    
  stickyNav();  
    
  $(window).scroll(function() {  
      stickyNav();  
  });  
  });  
</script>


</body>
</html>
